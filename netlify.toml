# Netlify configuration for Next.js 15 App Router

[build]
  # Build command
  command = "npm run build"
  
  # Directory to publish - não precisa especificar, Netlify detecta automaticamente
  # publish = ".next"

# Environment variables for build
[build.environment]
  # Node version for build
  NODE_VERSION = "20"
  
  # Next.js build optimization
  NEXT_TELEMETRY_DISABLED = "1"
  
  # Memory allocation for build
  NODE_OPTIONS = "--max-old-space-size=4096"
  
  # NPM cache optimization
  NPM_CONFIG_CACHE = "/opt/build/cache/npm"
  CYPRESS_CACHE_FOLDER = "/opt/build/cache/cypress"

# Headers configuration
[[headers]]
  for = "/*"
  [headers.values]
    # Security headers
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"
    
    # CORS headers for API
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization, X-Requested-With"

[[headers]]
  for = "/api/*"
  [headers.values]
    # API specific headers
    Cache-Control = "no-store, no-cache, must-revalidate"
    Access-Control-Max-Age = "86400"

# Next.js API routes funcionam automaticamente no Netlify
# Não precisa redirecionar para functions

# Redirect www to non-www
[[redirects]]
  from = "https://www.yourdomain.com/*"
  to = "https://yourdomain.com/:splat"
  status = 301
  force = true

# Handle SPA routing for dashboard
[[redirects]]
  from = "/dashboard/*"
  to = "/dashboard"
  status = 200

# Next.js functions são gerenciadas automaticamente
# [functions]
#   directory = "netlify/functions"

# Environment variable validation
[context.production.environment]
  # These are placeholders - actual values should be set in Netlify UI
  NEXT_PUBLIC_TENANT_ID = "REQUIRED - Set in Netlify dashboard"
  TENANT_ID = "REQUIRED - Set in Netlify dashboard"
  JWT_SECRET = "REQUIRED - Set in Netlify dashboard (min 32 chars)"
  OPENAI_API_KEY = "REQUIRED - Set in Netlify dashboard"
  
# Development context
[context.deploy-preview]
  command = "npm run build"
  
[context.branch-deploy]
  command = "npm run build"

# Dev settings
[dev]
  command = "npm run dev"
  targetPort = 3000
  port = 8888
  publish = ".next/standalone"
  autoLaunch = true