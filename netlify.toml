# Netlify configuration for Next.js 14 App Router

[build]
  # Build command
  command = "npm run build"
  
  # Directory to publish (Next.js standalone output)
  publish = ".next/standalone"
  
  # Functions directory for serverless functions
  functions = "netlify/functions"

# Environment variables for build
[build.environment]
  # Node version for build
  NODE_VERSION = "20"
  
  # Next.js specific
  NEXT_PRIVATE_TARGET = "server"
  
  # Enable Next.js on Netlify
  NETLIFY_USE_YARN = "false"
  
  # Increase build timeout
  AWS_LAMBDA_JS_RUNTIME = "nodejs20.x"
  
  # Next.js build optimization
  NEXT_TELEMETRY_DISABLED = "1"
  
  # Memory allocation for build
  NODE_OPTIONS = "--max-old-space-size=4096"

# Netlify Next.js Plugin
[[plugins]]
  package = "@netlify/plugin-nextjs"

# Headers configuration
[[headers]]
  for = "/*"
  [headers.values]
    # Security headers
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"
    
    # CORS headers for API
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Methods = "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers = "Content-Type, Authorization, X-Requested-With"

[[headers]]
  for = "/api/*"
  [headers.values]
    # API specific headers
    Cache-Control = "no-store, no-cache, must-revalidate"
    Access-Control-Max-Age = "86400"

# Redirects for API routes
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
  force = true

# Redirect www to non-www
[[redirects]]
  from = "https://www.yourdomain.com/*"
  to = "https://yourdomain.com/:splat"
  status = 301
  force = true

# Handle SPA routing for dashboard
[[redirects]]
  from = "/dashboard/*"
  to = "/dashboard"
  status = 200

# Function configuration
[functions]
  # Directory containing serverless functions
  directory = "netlify/functions"
  
  # Node bundler for better performance
  node_bundler = "esbuild"
  
  # Include files in functions
  included_files = ["lib/**", "app/api/**"]
  
  # External node modules
  external_node_modules = ["firebase-admin", "sharp"]

# Environment variable validation
[context.production.environment]
  # These are placeholders - actual values should be set in Netlify UI
  NEXT_PUBLIC_TENANT_ID = "REQUIRED - Set in Netlify dashboard"
  TENANT_ID = "REQUIRED - Set in Netlify dashboard"
  JWT_SECRET = "REQUIRED - Set in Netlify dashboard (min 32 chars)"
  OPENAI_API_KEY = "REQUIRED - Set in Netlify dashboard"
  
# Development context
[context.deploy-preview]
  command = "npm run build"
  
[context.branch-deploy]
  command = "npm run build"

# Dev settings
[dev]
  command = "npm run dev"
  targetPort = 3000
  port = 8888
  publish = ".next/standalone"
  autoLaunch = true