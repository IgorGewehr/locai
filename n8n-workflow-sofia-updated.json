{
  "name": "Sofia - Complete AI Sales & Booking System",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "61d4590e-41ec-4ba0-a9f9-4746c29364cb",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [-1408, 2256],
      "id": "webhook-main",
      "name": "Webhook Principal",
      "webhookId": "61d4590e-41ec-4ba0-a9f9-4746c29364cb"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "console.log(\"=== EXTRACT & VALIDATE MESSAGE ===\");\nconst body = $json.body;\n\nconst messageData = {\n  tenantId: body.tenantId,\n  clientPhone: body.data.from,\n  message: body.data.message,\n  messageId: body.data.messageId,\n  timestamp: body.data.timestamp || new Date().toISOString(),\n  source: 'whatsapp',\n  event: body.event\n};\n\n// Block group messages\nif (messageData.clientPhone?.includes('@g.us')) {\n  console.log('ðŸ‘¥ Group message blocked');\n  return null;\n}\n\n// Add replied message if exists\nif (body.data.messageReplied) {\n  messageData.messageReplied = body.data.messageReplied;\n}\n\n// Deduplication check\nconst dedupKey = `msg_${messageData.messageId}`;\nconst storage = $getWorkflowStaticData('global');\nif (!storage.processed) storage.processed = {};\n\nif (storage.processed[dedupKey]) {\n  console.log('ðŸš« Duplicate message blocked');\n  return { json: { ignored: true, reason: 'duplicate' } };\n}\n\n// Validate required fields\nif (!messageData.tenantId || !messageData.clientPhone || !messageData.message) {\n  throw new Error('Missing required fields');\n}\n\n// Mark as processed\nstorage.processed[dedupKey] = Date.now();\n\n// Check for human transfer pending\ntry {\n  const transferKey = `transfer_pending:${messageData.clientPhone}`;\n  const transferCheck = await $('Redis Chat Memory').execute({\n    operation: 'get',\n    key: transferKey\n  });\n  \n  if (transferCheck?.value) {\n    return {\n      json: {\n        ...messageData,\n        skip_ai: true,\n        transfer_pending: true\n      }\n    };\n  }\n} catch (error) {\n  console.log('âš ï¸ Transfer check failed, continuing');\n}\n\nreturn { json: messageData };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1104, 2240],
      "id": "message-extraction",
      "name": "Message Extraction"
    },
    {
      "parameters": {
        "conditions": {
          "options": { "caseSensitive": true, "typeValidation": "strict" },
          "conditions": [
            {
              "leftValue": "={{ $json.skip_ai }}",
              "rightValue": "true",
              "operator": { "type": "boolean", "operation": "true" }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [-912, 2240],
      "id": "check-skip-ai",
      "name": "Check Skip AI"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "const data = $json;\nreturn {\n  json: {\n    chatInput: `Mensagem: ${data.message}\\nContexto: ${data.messageReplied || 'primeira mensagem'}\\nTelefone: ${data.clientPhone}`,\n    message: data.message,\n    tenantId: data.tenantId,\n    clientPhone: data.clientPhone,\n    messageId: data.messageId,\n    timestamp: data.timestamp\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-624, 2240],
      "id": "format-input",
      "name": "Format Input"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "# ROUTER AGENT - COORDENADOR INTELIGENTE\n\n## SUA FUNÃ‡ÃƒO\nAnalise a mensagem e decida qual especialista deve responder. Retorne APENAS JSON.\n\n## AGENTES DISPONÃVEIS\n\n### 1ï¸âƒ£ SEARCH (ExploraÃ§Ã£o)\n**Cliente estÃ¡ EXPLORANDO, nÃ£o decidiu:**\n- \"quero alugar\" (genÃ©rico)\n- \"tem apartamento?\"\n- \"mostre opÃ§Ãµes\"\n- Busca inicial sem imÃ³vel especÃ­fico\n\n### 2ï¸âƒ£ SALES (NegociaÃ§Ã£o e Vendas)\n**Cliente estÃ¡ NEGOCIANDO ou tem OBJEÃ‡Ã•ES:**\n- \"estÃ¡ caro\", \"muito caro\"\n- \"tem desconto?\", \"pode fazer melhor?\"\n- \"vou pensar\", \"vou ver com minha esposa\"\n- DÃºvidas sobre preÃ§o ou condiÃ§Ãµes\n- Cliente hesitante, precisa ser convencido\n- Quer parcelar, pagar Ã  vista\n\n### 3ï¸âƒ£ BOOKING (Reservas)\n**Cliente JÃ DECIDIU, quer FINALIZAR:**\n- \"quanto custa o Vista Mar?\"\n- \"quero reservar ESTE\"\n- \"vou alugar\"\n- Escolheu imÃ³vel especÃ­fico\n- Quer modificar/cancelar reserva\n- HÃ³spede com problema (chuveiro quebrou, etc)\n\n### 4ï¸âƒ£ SUPPORT (EscalaÃ§Ã£o Humana)\n- \"quero falar com atendente/gerente\"\n- Pede transferÃªncia para humano\n\n### 5ï¸âƒ£ CONVERSATION (Relacionamento)\n- SaudaÃ§Ã£o isolada: \"oi\", \"bom dia\"\n- Pergunta vaga sem direÃ§Ã£o\n\n## ðŸŽ¯ PRIORIDADE DE ROTEAMENTO\n```\nSUPPORT > SALES (negociaÃ§Ã£o) > BOOKING (reserva) > SEARCH > CONVERSATION\n```\n\n## âš¡ REGRAS CRÃTICAS\n\n**\"EstÃ¡ caro\" / \"Muito caro\" â†’ SEMPRE SALES**\n**\"Tem desconto\" â†’ SEMPRE SALES**\n**\"Vou pensar\" â†’ SEMPRE SALES**\n**\"Quero alugar\" genÃ©rico â†’ SEARCH**\n**\"Quero alugar o X\" â†’ SALES (oferecer condiÃ§Ãµes) ou BOOKING (se jÃ¡ negociou)**\n\n## ðŸ“¤ FORMATO DE RESPOSTA\n```json\n{\n  \"agent\": \"SEARCH|SALES|BOOKING|SUPPORT|CONVERSATION\",\n  \"reason\": \"ExplicaÃ§Ã£o em 1 frase\",\n  \"context\": {\n    \"detected_intent\": \"string\",\n    \"priority\": \"high|medium|low\"\n  }\n}\n```\n\n## EXEMPLOS\n\n**\"EstÃ¡ muito caro\"**\n```json\n{\n  \"agent\": \"SALES\",\n  \"reason\": \"Cliente tem objeÃ§Ã£o de preÃ§o - precisa de negociaÃ§Ã£o\",\n  \"context\": { \"detected_intent\": \"price_objection\", \"priority\": \"high\" }\n}\n```\n\n**\"Quero alugar um apto\"**\n```json\n{\n  \"agent\": \"SEARCH\",\n  \"reason\": \"Cliente iniciando busca - explorar opÃ§Ãµes\",\n  \"context\": { \"detected_intent\": \"initial_search\", \"priority\": \"high\" }\n}\n```\n\n**\"Quanto custa o Vista Mar?\"**\n```json\n{\n  \"agent\": \"SALES\",\n  \"reason\": \"Cliente interessado em imÃ³vel especÃ­fico - apresentar preÃ§o e condiÃ§Ãµes\",\n  \"context\": { \"detected_intent\": \"price_inquiry\", \"priority\": \"high\" }\n}\n```"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [-352, 2208],
      "id": "router-agent",
      "name": "Router Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [-240, 2448],
      "id": "openai-router",
      "name": "OpenAI Router Model",
      "credentials": {
        "openAiApi": {
          "id": "Az6rTBtp4IWOXM65",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.output).agent }}",
                    "rightValue": "SEARCH",
                    "operator": { "type": "string", "operation": "contains" }
                  }
                ]
              },
              "outputIndex": 0
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.output).agent }}",
                    "rightValue": "SALES",
                    "operator": { "type": "string", "operation": "contains" }
                  }
                ]
              },
              "outputIndex": 1
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.output).agent }}",
                    "rightValue": "BOOKING",
                    "operator": { "type": "string", "operation": "contains" }
                  }
                ]
              },
              "outputIndex": 2
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.output).agent }}",
                    "rightValue": "SUPPORT",
                    "operator": { "type": "string", "operation": "contains" }
                  }
                ]
              },
              "outputIndex": 3
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ JSON.parse($json.output).agent }}",
                    "rightValue": "CONVERSATION",
                    "operator": { "type": "string", "operation": "contains" }
                  }
                ]
              },
              "outputIndex": 4
            }
          ]
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [32, 2208],
      "id": "route-switch",
      "name": "Route to Agent"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "=sofia:{{ $('Format Input').item.json.tenantId }}_{{ $('Format Input').item.json.clientPhone }}",
        "sessionTTL": 3600,
        "contextWindowLength": 35
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.5,
      "position": [528, 2608],
      "id": "redis-memory",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "lf4OzLzq4ScvHwto",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "# SEARCH AGENT - Especialista em ApresentaÃ§Ã£o de ImÃ³veis\n\nVocÃª Ã© Sofia, especialista em apresentar imÃ³veis de forma atrativa.\n\n## COMPORTAMENTO\n- Seja entusiasmada ao apresentar propriedades\n- Destaque os diferenciais (localizaÃ§Ã£o, comodidades)\n- Use linguagem sensorial: \"imagine acordar com vista pro mar\"\n- Mostre fotos e vÃ­deos\n- Sempre pergunte: \"Qual chamou mais atenÃ§Ã£o?\"\n\n## FERRAMENTAS DISPONÃVEIS\n- search-properties: Buscar imÃ³veis\n- get-property-details: Detalhes completos\n- send-property-media: Enviar fotos/vÃ­deos\n- send-property-map: Enviar localizaÃ§Ã£o\n- check-availability: Verificar disponibilidade\n\n## FLUXO\n1. Entender necessidades (datas, pessoas, local, orÃ§amento)\n2. Buscar propriedades\n3. Apresentar com entusiasmo\n4. Mostrar fotos/vÃ­deos\n5. Qualificar interesse\n6. Se cliente interessado â†’ transferir para SALES\n\n## EXEMPLO\n\"Olha, tenho UMA propriedade PERFEITA! ðŸ–ï¸\n\nO **Apto Vista Mar** fica a 50m da praia, tem ar condicionado em todos os quartos, Wi-Fi super rÃ¡pido e uma varanda INCRÃVEL!\n\nR$ 2.000 para 4 noites\n\nTe mando as fotos? ðŸ“¸\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [528, 1920],
      "id": "search-agent",
      "name": "SEARCH Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "# SALES AGENT - Especialista em NegociaÃ§Ã£o e Fechamento\n\n**IMPORTANTE: Use o system prompt completo de SALES_AGENT_SYSTEM_PROMPT.md**\n\nVocÃª Ã© Sofia, uma VENDEDORA profissional. Seu objetivo Ã© CONVERTER LEADS EM RESERVAS.\n\n## PERSONALIDADE\n- CarismÃ¡tica, persuasiva, empÃ¡tica\n- Entusiasmada mas profissional\n- Focada em resolver objeÃ§Ãµes\n- Cria urgÃªncia sem pressionar\n\n## TÃ‰CNICAS DE VENDA\n\n### 1. OBJEÃ‡ÃƒO: \"EstÃ¡ caro\"\n**A) Justificar valor:**\n- LocalizaÃ§Ã£o privilegiada\n- Alta temporada\n- ImÃ³vel premium\n\n**B) Oferecer desconto estratÃ©gico:**\n```\nUSE: calculate_dynamic_discount\n```\n\n**Exemplo:**\n\"Entendo! Deixa eu te fazer uma proposta especial:\n\nSe vocÃª fechar no PIX, consigo 10% de desconto! ðŸ’°\nDe R$ 2.000 por R$ 1.800. SÃ£o R$ 200 de economia!\n\nO que acha?\"\n\n### 2. OBJEÃ‡ÃƒO: \"Vou pensar\"\n**Criar urgÃªncia gentil:**\n\"Claro! Mas Ã³, tenho apenas 2 unidades para essas datas.\n\nSe vocÃª fechar nas prÃ³ximas 2 horas, te dou 5% adicional.\nVale a pena garantir logo!\"\n\n### 3. UPSELLING\n**Estender estadia:**\n\"Se vocÃª ficar 7 dias ao invÃ©s de 4, consigo 15% de desconto!\nMais 3 dias de fÃ©rias + economia. Compensa MUITO!\"\n\n## FERRAMENTAS SALES\n- calculate_dynamic_discount: Calcular descontos personalizados\n- create-reservation: Fechar venda\n- calculate_price: Calcular preÃ§o total\n- check_availability: Confirmar disponibilidade\n\n## FLUXO DE FECHAMENTO\n1. Identificar objeÃ§Ã£o\n2. Usar tÃ©cnica apropriada\n3. Oferecer desconto estratÃ©gico\n4. Criar urgÃªncia\n5. Assumir a venda\n6. FECHAR RESERVA\n\n## FECHAMENTO\n\"Perfeito! Vou confirmar:\n\nðŸ“ Apto Vista Mar\nðŸ“… 01/12 - 05/12\nðŸ‘¥ 4 pessoas\nðŸ’° R$ 1.800 (com desconto PIX)\n\nTudo certo? Te envio o link de pagamento! ðŸŽ‰\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [528, 2192],
      "id": "sales-agent",
      "name": "SALES Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "# BOOKING AGENT - Especialista em Reservas e Suporte\n\nVocÃª Ã© Sofia, especialista em finalizar reservas e dar suporte a hÃ³spedes.\n\n## COMPORTAMENTO\n- Eficiente e profissional\n- Coleta todos os dados necessÃ¡rios\n- Confirma informaÃ§Ãµes antes de finalizar\n- Resolve problemas de hÃ³spedes rapidamente\n\n## FERRAMENTAS\n- create-reservation: Criar reserva\n- calculate_price: Calcular preÃ§o final\n- check-availability: Verificar disponibilidade\n- register_client: Cadastrar cliente\n- schedule_meeting: Agendar visita\n- check_agenda_availability: Ver horÃ¡rios\n\n## FLUXO RESERVA\n1. Confirmar imÃ³vel escolhido\n2. Coletar dados: nome, email, CPF, datas, hÃ³spedes\n3. Calcular preÃ§o total\n4. Confirmar disponibilidade\n5. Criar reserva\n6. Enviar confirmaÃ§Ã£o\n\n## SUPORTE HÃ“SPEDE\nSe cliente jÃ¡ estÃ¡ hospedado + problema:\n- Entender problema\n- Oferecer soluÃ§Ã£o imediata\n- Escalar se necessÃ¡rio\n\n## EXEMPLO\n\"Perfeito! Preciso de alguns dados:\n\nâœ… Nome completo:\nâœ… Email:\nâœ… CPF:\nâœ… Confirma 4 hÃ³spedes?\n\nAssim que me passar, finalizo sua reserva!\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [528, 2464],
      "id": "booking-agent",
      "name": "BOOKING Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "# SUPPORT AGENT - EscalaÃ§Ã£o para Humano\n\nVocÃª identifica quando transferir para atendente humano.\n\nUSE: transfer_to_human\n\nResponda:\n\"Entendi! Vou te conectar com um atendente humano agora.\nAguarde um momento que jÃ¡ estou providenciando! ðŸ˜Š\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [528, 2736],
      "id": "support-agent",
      "name": "SUPPORT Agent"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.chatInput}}",
        "options": {
          "systemMessage": "# CONVERSATION AGENT - Relacionamento Inicial\n\nVocÃª Ã© Sofia, acolhedora e amigÃ¡vel.\n\n## COMPORTAMENTO\n- Responda saudaÃ§Ãµes com entusiasmo\n- Descubra o que o cliente procura\n- Conduza para SEARCH ou SALES\n\n## EXEMPLO\n\"Oi! Muito prazer, sou a Sofia! ðŸ˜Š\n\nEstou aqui para te ajudar a encontrar o imÃ³vel PERFEITO!\n\nMe conta: vocÃª estÃ¡ procurando para quando?\""
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [528, 3008],
      "id": "conversation-agent",
      "name": "CONVERSATION Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [752, 2608],
      "id": "openai-agents",
      "name": "OpenAI Agents Model",
      "credentials": {
        "openAiApi": {
          "id": "Az6rTBtp4IWOXM65",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "toolDescription": "Busca propriedades disponÃ­veis com filtros",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/search-properties/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"location\":\"{{$fromAI('location','LocalizaÃ§Ã£o')}}\",\"bedrooms\":\"{{$fromAI('bedrooms','Quartos','number')}}\",\"maxPrice\":\"{{$fromAI('maxPrice','PreÃ§o mÃ¡ximo','number')}}\",\"checkIn\":\"{{$fromAI('checkIn','Check-in YYYY-MM-DD')}}\",\"checkOut\":\"{{$fromAI('checkOut','Check-out YYYY-MM-DD')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1200, 1520],
      "id": "tool-search-properties",
      "name": "search-properties"
    },
    {
      "parameters": {
        "toolDescription": "Calcula desconto dinÃ¢mico baseado em critÃ©rios de negociaÃ§Ã£o",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/calculate-dynamic-discount/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"propertyName\":\"{{$fromAI('propertyName','Nome da propriedade')}}\",\"checkIn\":\"{{$fromAI('checkIn','Check-in YYYY-MM-DD')}}\",\"checkOut\":\"{{$fromAI('checkOut','Check-out YYYY-MM-DD')}}\",\"totalPrice\":\"{{$fromAI('totalPrice','PreÃ§o total','number')}}\",\"clientPhone\":\"{{$('Format Input').item.json.clientPhone}}\",\"paymentMethod\":\"{{$fromAI('paymentMethod','pix|card|cash')}}\",\"bookNow\":\"{{$fromAI('bookNow','Cliente quer fechar agora?','boolean',false)}}\",\"extendStay\":\"{{$fromAI('extendStay','Dias extras','number',0)}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1200, 1760],
      "id": "tool-calculate-discount",
      "name": "calculate_dynamic_discount"
    },
    {
      "parameters": {
        "toolDescription": "Calcula preÃ§o total com taxas",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/calculate-price/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"propertyName\":\"{{$fromAI('propertyName','Nome propriedade')}}\",\"checkIn\":\"{{$fromAI('checkIn','Check-in')}}\",\"checkOut\":\"{{$fromAI('checkOut','Check-out')}}\",\"guests\":\"{{$fromAI('guests','HÃ³spedes','number',2)}}\",\"clientPhone\":\"{{$('Format Input').item.json.clientPhone}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1200, 2000],
      "id": "tool-calculate-price",
      "name": "calculate_price"
    },
    {
      "parameters": {
        "toolDescription": "Envia fotos e vÃ­deos da propriedade",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/send-property-media",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"propertyName\":\"{{$fromAI('propertyName','Nome propriedade')}}\",\"mediaType\":\"{{$fromAI('mediaType','photos ou videos','string','photos')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1200, 1280],
      "id": "tool-send-media",
      "name": "send-property-media"
    },
    {
      "parameters": {
        "toolDescription": "Cria reserva confirmada",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/create-reservation/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"propertyName\":\"{{$fromAI('propertyName','Nome propriedade')}}\",\"clientName\":\"{{$fromAI('clientName','Nome cliente')}}\",\"clientPhone\":\"{{$('Format Input').item.json.clientPhone}}\",\"clientEmail\":\"{{$fromAI('clientEmail','Email')}}\",\"checkIn\":\"{{$fromAI('checkIn','Check-in')}}\",\"checkOut\":\"{{$fromAI('checkOut','Check-out')}}\",\"guests\":\"{{$fromAI('guests','HÃ³spedes','number')}}\",\"totalPrice\":\"{{$fromAI('totalPrice','PreÃ§o total','number')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1200, 1040],
      "id": "tool-create-reservation",
      "name": "create-reservation"
    },
    {
      "parameters": {
        "toolDescription": "Verifica disponibilidade de propriedade",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/check-availability/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"propertyName\":\"{{$fromAI('propertyName','Nome')}}\",\"checkIn\":\"{{$fromAI('checkIn','Check-in')}}\",\"checkOut\":\"{{$fromAI('checkOut','Check-out')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1200, 2240],
      "id": "tool-check-availability",
      "name": "check_availability"
    },
    {
      "parameters": {
        "toolDescription": "Cadastra cliente na base",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/register-client/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"name\":\"{{$fromAI('clientName','Nome')}}\",\"phone\":\"{{$('Format Input').item.json.clientPhone}}\",\"email\":\"{{$fromAI('clientEmail','Email')}}\",\"document\":\"{{$fromAI('clientDocument','CPF')}}\",\"whatsappNumber\":\"{{$('Format Input').item.json.clientPhone}}\",\"source\":\"whatsapp\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1440, 1040],
      "id": "tool-register-client",
      "name": "register_client"
    },
    {
      "parameters": {
        "toolDescription": "Agenda reuniÃ£o ou visita",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/schedule-meeting",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"clientName\":\"{{$fromAI('clientName','Nome')}}\",\"title\":\"{{$fromAI('title','TÃ­tulo reuniÃ£o')}}\",\"scheduledDate\":\"{{$fromAI('scheduledDate','Data YYYY-MM-DD')}}\",\"scheduledTime\":\"{{$fromAI('scheduledTime','Hora HH:MM')}}\",\"duration\":\"{{$fromAI('duration','DuraÃ§Ã£o minutos','number',60)}}\",\"clientPhone\":\"{{$('Format Input').item.json.clientPhone}}\",\"description\":\"{{$fromAI('description','DescriÃ§Ã£o')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1440, 1280],
      "id": "tool-schedule-meeting",
      "name": "schedule_meeting"
    },
    {
      "parameters": {
        "toolDescription": "Verifica horÃ¡rios disponÃ­veis na agenda",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/check-agenda-availability",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"year\":\"{{$fromAI('year','Ano','string','2025')}}\",\"month\":\"{{$fromAI('month','MÃªs nÃºmero')}}\",\"day\":\"{{$fromAI('day','Dia especÃ­fico ou vazio','')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1440, 1520],
      "id": "tool-check-agenda",
      "name": "check_agenda_availability"
    },
    {
      "parameters": {
        "toolDescription": "Envia mapa de localizaÃ§Ã£o da propriedade",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/send-property-map",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"propertyName\":\"{{$fromAI('propertyName','Nome propriedade')}}\"}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1440, 1760],
      "id": "tool-send-map",
      "name": "send_property_map"
    },
    {
      "parameters": {
        "toolDescription": "Transfere cliente para atendente humano",
        "description": "Use quando cliente pedir explicitamente para falar com humano, atendente, gerente ou pessoa real",
        "jsCode": "const phoneNumber = $('Format Input').item.json.clientPhone;\nconst transferKey = `transfer_pending:${phoneNumber}`;\n\nawait $('Redis Chat Memory').execute({\n  operation: 'set',\n  key: transferKey,\n  value: JSON.stringify({\n    status: 'waiting_human',\n    timestamp: new Date().toISOString()\n  }),\n  ttl: 86400\n});\n\nreturn \"Entendi! Vou te conectar com um atendente humano. Aguarde que jÃ¡ estou providenciando!\";"
      },
      "type": "@n8n/n8n-nodes-langchain.toolCode",
      "typeVersion": 1.3,
      "position": [1440, 2000],
      "id": "tool-transfer-human",
      "name": "transfer_to_human"
    },
    {
      "parameters": {
        "toolDescription": "Registra marco de qualificaÃ§Ã£o do lead",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/track-qualification-milestone/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"eventType\":\"qualification_milestone\",\"leadId\":\"{{$('Format Input').item.json.clientPhone}}\",\"eventData\":{\"milestone\":\"{{$fromAI('milestone','qualified|interested|hot_lead')}}\",\"timeToMilestone\":\"{{$fromAI('timeToMilestone','Tempo segundos','number',300)}}\",\"qualificationScore\":\"{{$fromAI('qualificationScore','Score 0-100','number',85)}}\",\"qualificationMethod\":\"sofia_conversation\"}}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1680, 1040],
      "id": "tool-track-qualification",
      "name": "track_qualification_milestone"
    },
    {
      "parameters": {
        "toolDescription": "Monitora engajamento em mensagens",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/track-message-engagement/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"eventType\":\"message_engagement\",\"leadId\":\"{{$('Format Input').item.json.clientPhone}}\",\"eventData\":{\"outcome\":\"{{$fromAI('outcome','responded|no_response')}}\",\"responseTime\":\"{{$fromAI('responseTime','Segundos','number',30)}}\",\"engagementLevel\":\"{{$fromAI('engagementLevel','active|passive')}}\",\"sentiment\":\"{{$fromAI('sentiment','positive|neutral|negative')}}\"}}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1680, 1280],
      "id": "tool-track-engagement",
      "name": "track_message_engagement"
    },
    {
      "parameters": {
        "toolDescription": "Rastreia progressÃ£o no funil",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/track-conversion-step/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"eventType\":\"conversion_step\",\"leadId\":\"{{$('Format Input').item.json.clientPhone}}\",\"eventData\":{\"from\":\"{{$fromAI('from','initial_contact|interested|qualified')}}\",\"to\":\"{{$fromAI('to','interested|qualified|proposal|won')}}\",\"interestLevel\":\"{{$fromAI('interestLevel','low|medium|high')}}\",\"conversionTrigger\":\"{{$fromAI('conversionTrigger','Gatilho')}}\"}}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1680, 1520],
      "id": "tool-track-conversion",
      "name": "track_conversion_step"
    },
    {
      "parameters": {
        "toolDescription": "Finaliza sessÃ£o com mÃ©tricas",
        "method": "POST",
        "url": "=https://alugazap.com/api/ai/functions/track-conversation-session/",
        "sendHeaders": true,
        "specifyHeaders": "json",
        "jsonHeaders": "{\"Content-Type\":\"application/json\"}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"tenantId\":\"{{$('Format Input').item.json.tenantId}}\",\"eventType\":\"conversation_session\",\"leadId\":\"{{$('Format Input').item.json.clientPhone}}\",\"eventData\":{\"duration\":\"{{$fromAI('duration','Segundos','number',420)}}\",\"messageCount\":\"{{$fromAI('messageCount','Mensagens','number',15)}}\",\"outcome\":\"{{$fromAI('outcome','completed|abandoned')}}\",\"satisfaction\":\"{{$fromAI('satisfaction','low|medium|high')}}\"}}"
      },
      "type": "n8n-nodes-base.httpRequestTool",
      "typeVersion": 4.2,
      "position": [1680, 1760],
      "id": "tool-track-session",
      "name": "track_conversation_session"
    },
    {
      "parameters": {
        "jsCode": "const codeData = $('Format Input').first().json;\nconst aiResponse = $input.first().json;\n\nif (!aiResponse?.output) {\n  return [{ message: \"Erro na resposta da IA\" }];\n}\n\nlet originalMessage = aiResponse.output.trim()\n  .replace(/\\\\n/g, '\\n')\n  .replace(/\\\\t/g, '\\t')\n  .replace(/\\n---\\n/g, '\\n\\n');\n\nfunction extractAndProcessUrls(messageText, tenantId, clientPhone, propertyIndex, totalProperties) {\n  const urlRegex = /https?:\\/\\/[^\\s\\n]+/g;\n  const urls = messageText.match(urlRegex) || [];\n  \n  if (urls.length === 0) {\n    return [{\n      tenantId,\n      to: clientPhone,\n      message: messageText,\n      type: 'text',\n      propertyIndex,\n      totalProperties\n    }];\n  }\n  \n  let textOnly = messageText;\n  urls.forEach(url => { textOnly = textOnly.replace(url, ''); });\n  textOnly = textOnly.replace(/\\n{3,}/g, '\\n\\n').trim();\n  \n  const imageUrls = urls.filter(url => \n    url.includes('firebasestorage') || url.includes('storage')\n  );\n  \n  const result = [];\n  \n  if (textOnly.length > 0) {\n    result.push({\n      tenantId,\n      to: clientPhone,\n      message: textOnly,\n      type: 'text',\n      propertyIndex,\n      totalProperties\n    });\n  }\n  \n  imageUrls.forEach((imageUrl, index) => {\n    result.push({\n      tenantId,\n      to: clientPhone,\n      mediaUrl: imageUrl,\n      type: 'image',\n      propertyIndex,\n      totalProperties,\n      imageIndex: index + 1,\n      totalImages: imageUrls.length\n    });\n  });\n  \n  return result;\n}\n\nconst PROPERTY_MARKERS = ['ðŸ ', 'ðŸŒŸ', 'âœ…', 'âž¡ï¸', 'ðŸ”¹', 'ðŸ¡'];\nconst paragraphs = originalMessage.split(/\\n\\s*\\n/).filter(p => p.trim() !== '');\n\nif (paragraphs.length <= 1) {\n  return extractAndProcessUrls(\n    originalMessage,\n    codeData.tenantId,\n    codeData.clientPhone,\n    0,\n    1\n  );\n}\n\nconst propertyParts = paragraphs.filter(p => \n  PROPERTY_MARKERS.some(marker => p.startsWith(marker))\n);\n\nif (propertyParts.length === 0) {\n  return extractAndProcessUrls(\n    originalMessage,\n    codeData.tenantId,\n    codeData.clientPhone,\n    0,\n    1\n  );\n}\n\nconst finalOutput = [];\npropertyParts.forEach((msg, index) => {\n  const messagesForProperty = extractAndProcessUrls(\n    msg,\n    codeData.tenantId,\n    codeData.clientPhone,\n    index,\n    propertyParts.length\n  );\n  finalOutput.push(...messagesForProperty);\n});\n\nreturn finalOutput;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1920, 2352],
      "id": "split-properties",
      "name": "Split Properties"
    },
    {
      "parameters": {
        "jsCode": "try {\n  const currentItem = $json;\n  \n  if (!currentItem?.to) {\n    return { json: { error: 'Missing recipient' } };\n  }\n  \n  const response = {\n    tenantId: currentItem.tenantId,\n    to: currentItem.to\n  };\n  \n  if (currentItem.type === 'text' && currentItem.message) {\n    response.message = currentItem.message;\n    response.type = \"text\";\n  } else if (currentItem.type === 'image' && currentItem.mediaUrl) {\n    response.message = currentItem.caption || ' ';\n    response.mediaUrls = [currentItem.mediaUrl];\n    response.type = \"media\";\n    response.mediaType = \"image\";\n  } else if (currentItem.message) {\n    response.message = currentItem.message;\n    response.type = \"text\";\n  } else {\n    return { json: { error: 'No valid content' } };\n  }\n  \n  return { json: response };\n} catch (error) {\n  return { json: { error: error.message } };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2192, 2480],
      "id": "format-response",
      "name": "Format Response"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=http://167.172.116.195:3000/api/v1/messages/{{ $json.tenantId }}/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Authorization",
              "value": "Bearer tTmMQE3Rdgu1UpwEwTBow4GmBU9XstTaGva2kIqGjCU="
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}"
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2592, 2768],
      "id": "send-whatsapp",
      "name": "Send WhatsApp"
    },
    {
      "parameters": {
        "jsCode": "const response = $json;\n\nconsole.log('ðŸ“‹ WhatsApp Response:', {\n  success: response.success,\n  messageId: response.messageId\n});\n\nif (response.success) {\n  return {\n    json: {\n      workflowComplete: true,\n      whatsappSent: true,\n      messageId: response.messageId,\n      finalStatus: 'success',\n      completedAt: new Date().toISOString()\n    }\n  };\n} else {\n  return {\n    json: {\n      workflowComplete: true,\n      whatsappSent: false,\n      error: response.error,\n      finalStatus: 'failed',\n      failedAt: new Date().toISOString()\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2800, 2912],
      "id": "send-confirmation",
      "name": "Send Confirmation"
    }
  ],
  "connections": {
    "Webhook Principal": {
      "main": [[{"node": "Message Extraction", "type": "main", "index": 0}]]
    },
    "Message Extraction": {
      "main": [[{"node": "Check Skip AI", "type": "main", "index": 0}]]
    },
    "Check Skip AI": {
      "main": [
        [],
        [{"node": "Format Input", "type": "main", "index": 0}]
      ]
    },
    "Format Input": {
      "main": [[{"node": "Router Agent", "type": "main", "index": 0}]]
    },
    "Router Agent": {
      "main": [[{"node": "Route to Agent", "type": "main", "index": 0}]]
    },
    "Route to Agent": {
      "main": [
        [{"node": "SEARCH Agent", "type": "main", "index": 0}],
        [{"node": "SALES Agent", "type": "main", "index": 0}],
        [{"node": "BOOKING Agent", "type": "main", "index": 0}],
        [{"node": "SUPPORT Agent", "type": "main", "index": 0}],
        [{"node": "CONVERSATION Agent", "type": "main", "index": 0}]
      ]
    },
    "SEARCH Agent": {
      "main": [[{"node": "Split Properties", "type": "main", "index": 0}]]
    },
    "SALES Agent": {
      "main": [[{"node": "Split Properties", "type": "main", "index": 0}]]
    },
    "BOOKING Agent": {
      "main": [[{"node": "Split Properties", "type": "main", "index": 0}]]
    },
    "SUPPORT Agent": {
      "main": [[{"node": "Split Properties", "type": "main", "index": 0}]]
    },
    "CONVERSATION Agent": {
      "main": [[{"node": "Split Properties", "type": "main", "index": 0}]]
    },
    "Split Properties": {
      "main": [[{"node": "Format Response", "type": "main", "index": 0}]]
    },
    "Format Response": {
      "main": [[{"node": "Send WhatsApp", "type": "main", "index": 0}]]
    },
    "Send WhatsApp": {
      "main": [[{"node": "Send Confirmation", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-06T00:00:00.000Z",
  "versionId": "latest"
}
